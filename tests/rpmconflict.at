#    rpmconflict.at: rpm file conflict tests

AT_BANNER([RPM file conflicts])

# ------------------------------
# (Build and) install conflicting package (should fail)
AT_SETUP([rpm -U to package with file conflict])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT
rm -rf "${TOPDIR}"

for p in "one" "two"; do
    runroot rpmbuild --quiet -bb \
        --define "pkg $p" \
	--define "filedata $p" \
          /data/SPECS/conflicttest.spec
done

runroot rpm -U "${TOPDIR}"/RPMS/noarch/conflictone-1.0-1.noarch.rpm
runroot rpm -U "${TOPDIR}"/RPMS/noarch/conflicttwo-1.0-1.noarch.rpm
],
[1],
[ignore],
[ignore])
AT_CLEANUP

# ------------------------------
# Install conflicting packages in same transaction (should fail)
AT_SETUP([rpm -U two packages with a conflicting file])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpm -U \
  "${TOPDIR}"/RPMS/noarch/conflictone-1.0-1.noarch.rpm \
  "${TOPDIR}"/RPMS/noarch/conflicttwo-1.0-1.noarch.rpm
],
[2],
[ignore],
[ignore])
AT_CLEANUP

# ------------------------------
# (Build and) install package with shareable file
AT_SETUP([rpm -U package with shareable file])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT
rm -rf "${TOPDIR}"

for p in "one" "two"; do
    runroot rpmbuild --quiet -bb \
        --define "pkg $p" \
	--define "filedata same_stuff" \
          /data/SPECS/conflicttest.spec
done

runroot rpm -U "${TOPDIR}"/RPMS/noarch/conflictone-1.0-1.noarch.rpm
runroot rpm -U "${TOPDIR}"/RPMS/noarch/conflicttwo-1.0-1.noarch.rpm
],
[0],
[ignore],
[ignore])
AT_CLEANUP

# ------------------------------
# Install packages with shareable file in same transaction
AT_SETUP([rpm -U two packages with shareable file])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpm -U \
  "${TOPDIR}"/RPMS/noarch/conflictone-1.0-1.noarch.rpm \
  "${TOPDIR}"/RPMS/noarch/conflicttwo-1.0-1.noarch.rpm
],
[0],
[ignore],
[ignore])
AT_CLEANUP

# ------------------------------
# File conflict between colored files, prefer 64bit
AT_SETUP([rpm -U multilib elf conflict, prefer 64bit])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  /data/RPMS/hello-2.0-1.i686.rpm \
  /data/RPMS/hello-2.0-1.x86_64.rpm
runroot rpm -q --qf "[[%{filestates:fstate} ]]" hello.i686 hello.x86_64
],
[0],
[wrong color normal normal normal normal normal normal normal normal normal ],
[])
AT_CLEANUP

# ------------------------------
# File conflict between colored files, prefer 32bit
AT_SETUP([rpm -U multilib elf conflict, prefer 32bit])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 1" \
  /data/RPMS/hello-2.0-1.i686.rpm \
  /data/RPMS/hello-2.0-1.x86_64.rpm
runroot rpm -q --qf "[[%{filestates:fstate} ]]" hello.i686 hello.x86_64
],
[0],
[normal normal normal normal normal wrong color normal normal normal normal ],
[])
AT_CLEANUP

# ------------------------------
# File conflict between colored and non-colored file 1
AT_SETUP([rpm -U multilib elf vs non-elf file conflict 1])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpmbuild --quiet -bb /data/SPECS/hello-script.spec

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  /data/RPMS/hello-2.0-1.x86_64.rpm \
  "${TOPDIR}"/RPMS/noarch/hello-script-1.0-1.noarch.rpm
],
[2],
[],
[	file /usr/bin/hello conflicts between attempted installs of hello-2.0-1.x86_64 and hello-script-1.0-1.noarch
])
AT_CLEANUP

# File conflict between colored and non-colored file 2
AT_SETUP([rpm -U multilib elf vs non-elf file conflict 2])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpmbuild --quiet -bb /data/SPECS/hello-script.spec

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  /data/RPMS/hello-2.0-1.x86_64.rpm

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  "${TOPDIR}"/RPMS/noarch/hello-script-1.0-1.noarch.rpm
],
[1],
[],
[	file /usr/bin/hello from install of hello-script-1.0-1.noarch conflicts with file from package hello-2.0-1.x86_64
])
AT_CLEANUP

# File conflict between colored and non-colored file 3
AT_SETUP([rpm -U multilib elf vs non-elf file conflict 3])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT

runroot rpmbuild --quiet -bb /data/SPECS/hello-script.spec

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  "${TOPDIR}"/RPMS/noarch/hello-script-1.0-1.noarch.rpm

runroot rpm -U --ignoreos --ignorearch --nodeps \
  --define "_transaction_color 3" \
  --define "_prefer_color 2" \
  /data/RPMS/hello-2.0-1.x86_64.rpm
],
[1],
[],
[	file /usr/bin/hello from install of hello-2.0-1.x86_64 conflicts with file from package hello-script-1.0-1.noarch
])
AT_CLEANUP

# ------------------------------
# Replace directory with symlink, this is expected to fail
AT_SETUP([rpm -U replacing directory with symlink])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT
rm -rf "${TOPDIR}"
rm -rf "${RPMTEST}"/usr/{share,lib}/symlinktest*

runroot rpmbuild --quiet -bb \
    --define "rel 1" --without symlink /data/SPECS/symlinktest.spec
runroot rpmbuild --quiet -bb \
    --define "rel 2" --with symlink /data/SPECS/symlinktest.spec

runroot rpm -U "${TOPDIR}"/RPMS/noarch/symlinktest-1.0-1.noarch.rpm
runroot rpm -U "${TOPDIR}"/RPMS/noarch/symlinktest-1.0-2.noarch.rpm
],
[1],
[],
[error: unpacking of archive failed on file /usr/share/symlinktest: cpio: rename failed - Is a directory
error: symlinktest-1.0-2.noarch: install failed
error: symlinktest-1.0-1.noarch: erase skipped
])
AT_CLEANUP

# ------------------------------
# Replace symlink with a directory - the upgrade succeeds but leaves an
# orphan directory that the symlink now points to. Should verify the
# result more carefully...
AT_SETUP([rpm -U replacing symlink with directory])
AT_KEYWORDS([install])
AT_CHECK([
RPMDB_CLEAR
RPMDB_INIT
rm -rf "${TOPDIR}"
rm -rf "${RPMTEST}"/usr/{share,lib}/symlinktest*

runroot rpmbuild --quiet -bb \
    --define "rel 1" --with symlink /data/SPECS/symlinktest.spec
runroot rpmbuild --quiet -bb \
    --define "rel 2" --without symlink /data/SPECS/symlinktest.spec

runroot rpm -U "${TOPDIR}"/RPMS/noarch/symlinktest-1.0-1.noarch.rpm
runroot rpm -U "${TOPDIR}"/RPMS/noarch/symlinktest-1.0-2.noarch.rpm
],
[0],
[],
[])
AT_CLEANUP
